{"ast":null,"code":"import { db, FirebaseTimestamp } from \"../../firebase/index\";\nimport { push } from \"connected-react-router\";\nimport { fetchProductsAction, deleteProductsAction } from \"./actions\";\nconst productsRef = db.collection(\"products\"); // 商品を削除するメソット\n\nexport const deleteProduct = id => {\n  return async (dispatch, getState) => {\n    productsRef.doc(id).delete().then(() => {\n      const prevState = getState().products.list;\n      const nextProducts = prevState.filter(product => product.id !== id);\n      dispatch(deleteProductsAction(nextProducts));\n    });\n  };\n}; // firebaseから商品情報を取得\n\nexport const fetchProducts = (gender, category) => {\n  return async dispatch => {\n    let query = productsRef.orderBy('updated_at', 'desc');\n    query = gender !== \"\" ? query.where('gender', \"==\", gender) : query;\n    query = category !== \"\" ? query.where('category', \"==\", category) : query;\n    query.get().then(snapshots => {\n      const productList = [];\n      snapshots.forEach(snapshot => {\n        const product = snapshot.data();\n        productList.push(product);\n      });\n      dispatch(fetchProductsAction(productList));\n    });\n  };\n}; // カート商品の注文の処理\n\nexport const orderProduct = (productsInCart, price) => {\n  return async (dispatch, getState) => {\n    const uid = getState().users.uid; // 現在のログインユーザーの取得\n\n    const userRef = db.collection('users').doc(uid); // 現在のログインユーザーのfirebase情報取得\n\n    const timestamp = FirebaseTimestamp.now(); // 現在時刻の取得\n\n    let products = {}; // カートの商品を一旦格納する\n\n    let soldOutProducts = []; // 売り切れ商品\n\n    const batch = db.batch(); // カート内の商品1つ1つに対して処理を行う\n\n    for (const product of productsInCart) {\n      const snapshot = await productsRef.doc(product.productId).get(); // カート内の商品idの取得\n\n      const sizes = snapshot.data().sizes; // firebaseのproductコレクションからsize情報を取得\n      // sizeのオブジェクトの個数を減らす処理\n\n      const updateSizes = sizes.map(size => {\n        // カート商品と一致している場合\n        if (size.size === product.size) {\n          //  カート内部に入れている間に商品が購入された時の処理\n          if (size.quantity === 0) {\n            soldOutProducts.push(product.name);\n            return size;\n          } //  新しいサイズのオブジェクトを作成\n\n\n          return {\n            size: size.size,\n            quantity: size.quantity - 1\n          };\n        } else {\n          // 個数の変更はなくそのまま返す\n          return size;\n        }\n      }); // 注文履歴を残す\n\n      products[product.productId] = {\n        id: product.productId,\n        images: product.images,\n        name: product.name,\n        price: product.price,\n        size: product.size\n      }; // バッチ処理を記述する\n\n      batch.update(productsRef.doc(product.productId), {\n        sizes: updateSizes\n      });\n      batch.delete(userRef.collection('cart').doc(product.cartId));\n    } //  在庫がない商品が存在した場合は処理を起こさない\n    //  for文の外で実装を行う\n\n\n    if (soldOutProducts.length > 0) {\n      const errormessage = soldOutProducts.length > 1 ? soldOutProducts.join('と') : soldOutProducts[0];\n      alert('大変申し訳ございません' + errormessage + 'は在庫切れとなったため注文処理を中断しました');\n      return false;\n    } else {\n      // 先ほどのbatch処理を全て行う\n      batch.commit().then(() => {\n        // firebaseに注文履歴を残す\n        const orderRef = userRef.collection('orders').doc();\n        const date = timestamp.toDate(); // Calculate shipping date which is the date after 3 days\n\n        const shippingDate = FirebaseTimestamp.fromDate(new Date(date.setDate(date.getDate() + 3)));\n        const history = {\n          amount: price,\n          created_at: timestamp,\n          id: orderRef.id,\n          products: products,\n          shipping_date: shippingDate,\n          updated_at: timestamp\n        }; // 全てが完了したら上記を保存して、注文確認ページへpush\n\n        orderRef.set(history);\n        dispatch(push('/'));\n      }).catch(() => {\n        alert('注文処理に失敗しました。通信環境もご確認の、もう一度お試しください');\n      });\n    }\n  };\n};\nexport const saveProduct = (id, name, description, category, gender, price, images, sizes) => {\n  return async dispatch => {\n    const timestamp = FirebaseTimestamp.now();\n    const data = {\n      category: category,\n      description: description,\n      gender: gender,\n      images: images,\n      name: name,\n      price: parseInt(price, 10),\n      updated_at: timestamp,\n      sizes: sizes\n    };\n\n    if (id === \"\") {\n      const ref = productsRef.doc();\n      data.created_at = timestamp;\n      id = ref.id;\n      data.id = id;\n    }\n\n    return productsRef.doc(id).set(data, {\n      merge: true\n    }).then(() => {\n      dispatch(push('/'));\n    }).catch(error => {\n      throw new Error(error);\n    });\n  };\n};","map":{"version":3,"sources":["/Users/itoukazunari/Desktop/ec-app/src/reducks/products/operations.js"],"names":["db","FirebaseTimestamp","push","fetchProductsAction","deleteProductsAction","productsRef","collection","deleteProduct","id","dispatch","getState","doc","delete","then","prevState","products","list","nextProducts","filter","product","fetchProducts","gender","category","query","orderBy","where","get","snapshots","productList","forEach","snapshot","data","orderProduct","productsInCart","price","uid","users","userRef","timestamp","now","soldOutProducts","batch","productId","sizes","updateSizes","map","size","quantity","name","images","update","cartId","length","errormessage","join","alert","commit","orderRef","date","toDate","shippingDate","fromDate","Date","setDate","getDate","history","amount","created_at","shipping_date","updated_at","set","catch","saveProduct","description","parseInt","ref","merge","error","Error"],"mappings":"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","sourcesContent":["import { db, FirebaseTimestamp } from \"../../firebase/index\";\nimport { push } from \"connected-react-router\";\nimport {fetchProductsAction, deleteProductsAction} from \"./actions\"\n\n\nconst productsRef = db.collection(\"products\");\n\n\n// 商品を削除するメソット\nexport const deleteProduct = (id)=>{\n  return async(dispatch, getState) => {\n      productsRef.doc(id).delete()\n      .then(()=>{\n          const prevState = getState().products.list;\n         const nextProducts = prevState.filter(product => product.id !== id)\n          dispatch(deleteProductsAction(nextProducts))\n      })\n  }\n}\n\n// firebaseから商品情報を取得\nexport const fetchProducts = (gender, category) => {\n  \n  return async(dispatch) => {\n\n      let query =  productsRef.orderBy('updated_at', 'desc');\n      query = (gender !== \"\") ? query.where('gender', \"==\", gender) : query;\n      query = (category !== \"\") ? query.where('category', \"==\", category) : query;\n\n      query.get().then(snapshots => {\n          const productList = []\n          snapshots.forEach(snapshot => {\n            const product = snapshot.data();\n            productList.push(product);\n          })\n          dispatch(fetchProductsAction(productList))\n      })\n  }\n}\n\n// カート商品の注文の処理\nexport const orderProduct = (productsInCart, price) => {\n    return async(dispatch, getState) => {\n\n      const uid = getState().users.uid; // 現在のログインユーザーの取得\n      const userRef = db.collection('users').doc(uid) // 現在のログインユーザーのfirebase情報取得\n      const timestamp = FirebaseTimestamp.now() // 現在時刻の取得\n\n      let products = {}; // カートの商品を一旦格納する\n      let soldOutProducts = []; // 売り切れ商品\n\n      const batch = db.batch();\n\n      // カート内の商品1つ1つに対して処理を行う\n      for(const product of productsInCart){\n        const snapshot = await  productsRef.doc(product.productId).get(); // カート内の商品idの取得\n        const sizes = snapshot.data().sizes; // firebaseのproductコレクションからsize情報を取得\n\n        // sizeのオブジェクトの個数を減らす処理\n        const updateSizes = sizes.map(size => {\n          // カート商品と一致している場合\n          if(size.size === product.size){\n            //  カート内部に入れている間に商品が購入された時の処理\n             if (size.quantity === 0){\n                soldOutProducts.push(product.name);\n                return size\n             }\n            //  新しいサイズのオブジェクトを作成\n             return{\n               size: size.size,\n               quantity: size.quantity - 1\n             }\n          }else{\n            // 個数の変更はなくそのまま返す\n            return size\n          }\n        });\n        // 注文履歴を残す\n        products[product.productId] = {\n              id: product.productId,\n              images: product.images,\n              name: product.name,\n              price: product.price,\n              size: product.size\n          };\n\n        // バッチ処理を記述する\n         batch.update(\n          productsRef.doc(product.productId),\n            {sizes:updateSizes}\n        )\n\n        batch.delete(\n          userRef.collection('cart').doc(product.cartId)\n        )\n      }\n\n       //  在庫がない商品が存在した場合は処理を起こさない\n      //  for文の外で実装を行う\n        if(soldOutProducts.length > 0) {\n          const errormessage = (soldOutProducts.length > 1) ? \n            soldOutProducts.join('と') :\n            soldOutProducts[0];\n          alert('大変申し訳ございません' + errormessage + 'は在庫切れとなったため注文処理を中断しました')\n          return false\n        }else{\n            // 先ほどのbatch処理を全て行う\n          batch.commit()\n            .then(()=>{\n              // firebaseに注文履歴を残す\n                const orderRef = userRef.collection('orders').doc();\n                const date = timestamp.toDate();\n                // Calculate shipping date which is the date after 3 days\n                const shippingDate = FirebaseTimestamp.fromDate(new Date(date.setDate(date.getDate() + 3)));\n\n                const history = {\n                  amount: price,\n                  created_at: timestamp,\n                  id: orderRef.id,\n                  products: products,\n                  shipping_date: shippingDate,\n                  updated_at: timestamp\n                }\n\n                // 全てが完了したら上記を保存して、注文確認ページへpush\n                orderRef.set(history);\n                dispatch(push('/'))\n\n            }).catch(()=>{\n              alert('注文処理に失敗しました。通信環境もご確認の、もう一度お試しください')\n            })\n        }\n    }\n}\n\nexport const saveProduct = (\n  id,\n  name,\n  description,\n  category,\n  gender,\n  price,\n  images,\n  sizes\n) => {\n  return async (dispatch) => {\n    const timestamp = FirebaseTimestamp.now();\n\n      const data = {\n        category: category,\n        description: description,\n        gender: gender,\n        images: images,\n        name: name,\n        price: parseInt(price, 10),\n        updated_at: timestamp,\n        sizes:sizes\n      }\n\n      if (id === \"\") {\n            const ref = productsRef.doc()\n            data.created_at = timestamp;\n            id = ref.id;\n            data.id = id;\n        }\n\n     return productsRef.doc(id).set(data, {merge: true})\n            .then(() => {\n                dispatch(push('/'))\n            }).catch((error) => {\n                throw new Error(error)\n            })\n    \n  };\n};"]},"metadata":{},"sourceType":"module"}