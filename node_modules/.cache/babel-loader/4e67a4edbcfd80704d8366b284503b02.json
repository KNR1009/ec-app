{"ast":null,"code":"import { CardElement } from '@stripe/react-stripe-js';\nimport { db, FirebaseTimestamp } from \"../../firebase/index\";\nimport { push } from \"connected-react-router\";\nimport { useDispatch } from 'react-redux';\nimport { updateUserStateAction } from '../users/actions'; // Set Header\n\nconst headers = new Headers();\nheaders.set('Content-type', 'application/json');\nconst BASE_URL = \"https://ec-app-8ba0b.web.app\"; // 新規登録を行うAPI\n\nconst createCustomer = async (email, paymentMethodId, uid) => {\n  const response = await fetch(BASE_URL + '/v1/customer', {\n    method: 'POST',\n    headers: headers,\n    body: JSON.stringify({\n      email: email,\n      paymentMethod: paymentMethodId,\n      userId: uid\n    })\n  });\n  const customerResponse = await response.json();\n  return JSON.parse(customerResponse.body);\n};\n\nexport const registerCard = (stripe, elements) => {\n  return async (dispatch, getState) => {\n    const user = getState().users;\n    const email = user.email;\n    const uid = user.uid;\n\n    if (!stripe || !elements) {\n      // Stripe.js has not loaded yet. Make sure to disable\n      // form submission until Stripe.js has loaded.\n      console.error(\"Does not exist stripe or elements\");\n      return;\n    } // Get a reference to a mounted CardElement. Elements knows how\n    // to find your CardElement because there can only ever be one of\n    // each type of element.\n\n\n    const cardElement = elements.getElement(CardElement); // Use your card Element with other Stripe.js APIs\n\n    const {\n      error,\n      paymentMethod\n    } = await stripe.createPaymentMethod({\n      type: 'card',\n      card: cardElement\n    });\n\n    if (error) {\n      alert('error');\n      return;\n    }\n\n    const paymentMethodId = paymentMethod === null || paymentMethod === void 0 ? void 0 : paymentMethod.id;\n    const customerData = await createCustomer(email, paymentMethodId, uid); // 処理がうまくいっているのかの確認を行う\n\n    if (customerData.id === \"\") {\n      alert('カード情報の登録に失敗しました');\n      return;\n    } else {\n      const updateUserState = {\n        customer_id: customerData.id,\n        payment_method_id: paymentMethodId\n      };\n      db.collection('users').doc(uid).update(updateUserState).then(() => {\n        dispatch(updateUserStateAction(updateUserState));\n        dispatch(push('/user/mypage'));\n      }).catch(error => {});\n    }\n  };\n};","map":{"version":3,"sources":["/Users/itoukazunari/Desktop/ec-app/src/reducks/payments/operations.js"],"names":["CardElement","db","FirebaseTimestamp","push","useDispatch","updateUserStateAction","headers","Headers","set","BASE_URL","createCustomer","email","paymentMethodId","uid","response","fetch","method","body","JSON","stringify","paymentMethod","userId","customerResponse","json","parse","registerCard","stripe","elements","dispatch","getState","user","users","console","error","cardElement","getElement","createPaymentMethod","type","card","alert","id","customerData","updateUserState","customer_id","payment_method_id","collection","doc","update","then","catch"],"mappings":"AAAA,SAAQA,WAAR,QAA0B,yBAA1B;AACA,SAASC,EAAT,EAAaC,iBAAb,QAAsC,sBAAtC;AACA,SAASC,IAAT,QAAqB,wBAArB;AACA,SAASC,WAAT,QAA4B,aAA5B;AACA,SAASC,qBAAT,QAAsC,kBAAtC,C,CAGA;;AACA,MAAMC,OAAO,GAAG,IAAIC,OAAJ,EAAhB;AACAD,OAAO,CAACE,GAAR,CAAY,cAAZ,EAA4B,kBAA5B;AACA,MAAMC,QAAQ,GAAG,8BAAjB,C,CAEA;;AACA,MAAMC,cAAc,GAAG,OAAOC,KAAP,EAAcC,eAAd,EAA+BC,GAA/B,KAAuC;AAC1D,QAAMC,QAAQ,GAAG,MAAMC,KAAK,CAACN,QAAQ,GAAG,cAAZ,EAA4B;AACpDO,IAAAA,MAAM,EAAE,MAD4C;AAEpDV,IAAAA,OAAO,EAAEA,OAF2C;AAGpDW,IAAAA,IAAI,EAAEC,IAAI,CAACC,SAAL,CAAe;AACjBR,MAAAA,KAAK,EAAEA,KADU;AAEjBS,MAAAA,aAAa,EAAER,eAFE;AAGjBS,MAAAA,MAAM,EAAER;AAHS,KAAf;AAH8C,GAA5B,CAA5B;AAUA,QAAMS,gBAAgB,GAAG,MAAMR,QAAQ,CAACS,IAAT,EAA/B;AACA,SAAOL,IAAI,CAACM,KAAL,CAAWF,gBAAgB,CAACL,IAA5B,CAAP;AACH,CAbD;;AAgBA,OAAO,MAAMQ,YAAY,GAAG,CAACC,MAAD,EAASC,QAAT,KAAsB;AAChD,SAAO,OAAOC,QAAP,EAAiBC,QAAjB,KAA6B;AAClC,UAAMC,IAAI,GAAGD,QAAQ,GAAGE,KAAxB;AACA,UAAMpB,KAAK,GAAGmB,IAAI,CAACnB,KAAnB;AACA,UAAME,GAAG,GAAGiB,IAAI,CAACjB,GAAjB;;AAEA,QAAI,CAACa,MAAD,IAAW,CAACC,QAAhB,EAA0B;AACxB;AACA;AACAK,MAAAA,OAAO,CAACC,KAAR,CAAc,mCAAd;AACA;AACD,KAViC,CAYlC;AACA;AACA;;;AACA,UAAMC,WAAW,GAAGP,QAAQ,CAACQ,UAAT,CAAoBnC,WAApB,CAApB,CAfkC,CAiBlC;;AACA,UAAM;AAACiC,MAAAA,KAAD;AAAQb,MAAAA;AAAR,QAAyB,MAAMM,MAAM,CAACU,mBAAP,CAA2B;AAC9DC,MAAAA,IAAI,EAAE,MADwD;AAE9DC,MAAAA,IAAI,EAAEJ;AAFwD,KAA3B,CAArC;;AAKA,QAAID,KAAJ,EAAW;AACTM,MAAAA,KAAK,CAAC,OAAD,CAAL;AACA;AACD;;AAED,UAAM3B,eAAe,GAAGQ,aAAH,aAAGA,aAAH,uBAAGA,aAAa,CAAEoB,EAAvC;AACA,UAAMC,YAAY,GAAG,MAAM/B,cAAc,CAACC,KAAD,EAAQC,eAAR,EAAyBC,GAAzB,CAAzC,CA7BkC,CA+BlC;;AACA,QAAG4B,YAAY,CAACD,EAAb,KAAoB,EAAvB,EAA0B;AACxBD,MAAAA,KAAK,CAAC,iBAAD,CAAL;AACA;AACD,KAHD,MAGK;AACF,YAAMG,eAAe,GAAG;AACrBC,QAAAA,WAAW,EAAEF,YAAY,CAACD,EADL;AAErBI,QAAAA,iBAAiB,EAAEhC;AAFE,OAAxB;AAKHX,MAAAA,EAAE,CAAC4C,UAAH,CAAc,OAAd,EAAuBC,GAAvB,CAA2BjC,GAA3B,EACGkC,MADH,CACUL,eADV,EAEGM,IAFH,CAEQ,MAAI;AACRpB,QAAAA,QAAQ,CAACvB,qBAAqB,CAACqC,eAAD,CAAtB,CAAR;AACAd,QAAAA,QAAQ,CAACzB,IAAI,CAAC,cAAD,CAAL,CAAR;AACD,OALH,EAKK8C,KALL,CAKYhB,KAAD,IAAS,CAEjB,CAPH;AAQC;AAEF,GAnDD;AAoDD,CArDM","sourcesContent":["import {CardElement} from '@stripe/react-stripe-js';\nimport { db, FirebaseTimestamp } from \"../../firebase/index\";\nimport { push } from \"connected-react-router\";\nimport { useDispatch } from 'react-redux';\nimport { updateUserStateAction } from '../users/actions'\n\n\n// Set Header\nconst headers = new Headers();\nheaders.set('Content-type', 'application/json');\nconst BASE_URL = \"https://ec-app-8ba0b.web.app\"\n\n// 新規登録を行うAPI\nconst createCustomer = async (email, paymentMethodId, uid) => {\n    const response = await fetch(BASE_URL + '/v1/customer', {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify({\n            email: email,\n            paymentMethod: paymentMethodId,\n            userId: uid,\n        })\n    });\n\n    const customerResponse = await response.json();\n    return JSON.parse(customerResponse.body);\n}\n\n\nexport const registerCard = (stripe, elements) => {\n  return async (dispatch, getState)=> {\n    const user = getState().users;\n    const email = user.email;\n    const uid = user.uid;\n\n    if (!stripe || !elements) {\n      // Stripe.js has not loaded yet. Make sure to disable\n      // form submission until Stripe.js has loaded.\n      console.error(\"Does not exist stripe or elements\");\n      return;\n    }\n\n    // Get a reference to a mounted CardElement. Elements knows how\n    // to find your CardElement because there can only ever be one of\n    // each type of element.\n    const cardElement = elements.getElement(CardElement);\n\n    // Use your card Element with other Stripe.js APIs\n    const {error, paymentMethod} = await stripe.createPaymentMethod({\n      type: 'card',\n      card: cardElement,\n    });\n\n    if (error) {\n      alert('error')\n      return;\n    } \n\n    const paymentMethodId = paymentMethod?.id;\n    const customerData = await createCustomer(email, paymentMethodId, uid)\n\n    // 処理がうまくいっているのかの確認を行う\n    if(customerData.id === \"\"){\n      alert('カード情報の登録に失敗しました')\n      return;\n    }else{\n       const updateUserState = {\n          customer_id: customerData.id,\n          payment_method_id: paymentMethodId\n      }\n\n    db.collection('users').doc(uid)\n      .update(updateUserState)\n      .then(()=>{\n        dispatch(updateUserStateAction(updateUserState))\n        dispatch(push('/user/mypage'))\n      }).catch((error)=>{\n        \n      })\n    }\n    \n  }\n}"]},"metadata":{},"sourceType":"module"}